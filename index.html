<html>
<link rel="stylesheet" type="text/css" href="fonts/fonts.css" />
<style>
    body { font-family: Quattrocento; background-color: black; color: whitesmoke; line-height: 1.25rem; margin: 0; padding: 1rem; }
    div { padding-bottom: 4px; }
    h1 { margin: 0; padding: 1rem; }
    h2 { margin: 0; padding-bottom: 1rem; }
    h3 { margin: 0; padding-top: 1rem; padding-bottom: 0.5rem; }
    a { text-decoration-color: whitesmoke; color: whitesmoke; text-decoration-thickness: 0;}

    #container { display: flex; flex-direction: row; justify-content: center; }
    #container-parent { display: flex; flex-direction: column; justify-content: center; min-height: 100%; }
    #container-index { padding-right: 24px; }
    #container-chronology { padding-left: 24px; }
    #container-chronology h2 { padding-bottom: 0; }
        
    .hide { display: none; }
</style>
<script src="scripts/marked.min.js"></script>
<script>
    var root_download_url = "https://raw.githubusercontent.com/culturing/Poems/main/Poems/";

    async function onLoad() {        
        var res = await fetch('https://api.github.com/repos/culturing/Poems/contents/Poems')
        var poems = await res.json();

        res = await fetch('https://raw.githubusercontent.com/culturing/Poems/main/README.md')
        var readme = await res.text();

        var poemsByPath = {}
        var poemDivs = []

        var indexDiv = document.createElement('div');

        for (var poem of poems) {
            var div = document.createElement('div');            
            var title = poem.name.replace('.md', '');
            var href = `${window.location.href}poem.html?title=${encodeURIComponent(title)}`
            div.innerHTML = `<a href="${href}">${title}</a>`;
            indexDiv.appendChild(div);
            poemsByPath[encodeURIComponent(poem.path)] = poem;

        // load poem into browser cache
            var root_url = `https://raw.githubusercontent.com/culturing/Poems/main`;
            var text_url = `${root_url}/Poems/${title}.md`;
            fetch(text_url);
        }

        var chronologyDiv = document.createElement('div');
        chronologyDiv.innerHTML = marked(readme)
            .replaceAll('%20', ' ')
            .replaceAll('<li', '<div').replaceAll('</li', '</div')
            .replaceAll('<ul', '<div').replaceAll('</ul', '</div');

        for (var anchor of chronologyDiv.querySelectorAll('a'))
        {
            if (anchor.href != null)
            {
                var path = encodeURIComponent(anchor.attributes.href.value);
                var poem = poemsByPath[path];
                if (poem != null)
                {
                    var title = poem.name.replace('.md', '');
                    anchor.href = `${window.location.href}poem.html?title=${encodeURIComponent(title)}`
                }
            }
        }

        document.getElementById('container-index').appendChild(indexDiv);
        document.getElementById('container-chronology').appendChild(chronologyDiv);

        for (var node of document.querySelectorAll('.hide'))
        {
            node.classList.remove('hide');
        }
    }
    onLoad();
    
    console.log("Like looking under the hood? https://github.com/culturing/Poems");
</script>

<body>
    <h1 class="hide">Poems</h1>
    <div id="container-parent">
        <div id="container">
            <div id="container-index">
                <h2 class="hide">Index</h2>
            </div>
            <div id="container-chronology">
            </div>
        </div>
    </div>
</body>
</html>